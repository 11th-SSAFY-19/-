# 안정 해시 설계
수평적 규모 확장성을 달성하기 위해서는 요청 또는 데이터를 서버에 균등하게 나누는 것이 중요하다. 이 목표를 달성하기 위해 `안정 해시`라는 것을 사용하게 된다.

## 📌 해시 키 재배치(rehash) 문제
아래는 N개의 캐시서버가 있을 때 서버들에 부하를 균등하게 나누는 보편적인 방법이다.

> serverIndex = hash(key) % N (N : 서버의 개수)

![image](https://github.com/11th-SSAFY-19/large-scale-system-design/assets/80228712/6fb13ea9-17a9-4d8f-98af-d69168ca3dec)

특정한 키가 보관된 서버를 알아내기 위해 모듈러 연산으로 나눈 상태이다.

![image](https://github.com/11th-SSAFY-19/large-scale-system-design/assets/80228712/395b0f0a-7db1-447a-afd7-92edd4e0d99b)

이 방법은 서버 풀의 크기가 고정되어 있을 때, 데이터 분포가 균등할 때 잘 동작한다.
***
하지만, 서버가 추가되거나 기존 서버가 삭제 되면 원치 않은 작동을 한다. <br><br>
💡 **아래는 1번 서버가 장애를 일으켜 이후 3개의 서버로 동작한다고 할 때의 예이다.**

![image](https://github.com/11th-SSAFY-19/large-scale-system-design/assets/80228712/a3e71f58-73e6-4e0b-821b-6aad868c5390)

장애가 발생한 1번 서버에서 보관되어 있는 키 뿐만 아니라 대부분의 키가 재분배되었다.
```
1번 서버가 죽으면 대부분 캐시 클라이언트가 데이터가 없는 엉뚱한 서버에 접속하게 될 것이다. 즉, 이는 대규모 캐시 미스 발생이 생길것이라는 얘기이다.
```

![image](https://github.com/11th-SSAFY-19/large-scale-system-design/assets/80228712/ab6c0616-d586-45a6-b5ad-3003e6649bb9)


## 📌 안정 해시
해시 테이블 크기가 조정될 때 평균적으로 오직 k(키의 개수)/n(슬롯의 개수)개의 키만 재배치 하는 캐시 기술이다. 

🔎 **키 & 슬롯**
- 키 : 해시 테이블에 저장할 데이터의 식별자. 해시 함수에 입력되어 고유한 해시 값을 생성한다.
- 슬롯 : 해시 테이블에서 데이터를 저장하는 위치(버킷). 해시 함수가 생성한 해시 값에 따라 특정 슬롯에 데이터가 저장된다.

### 해시 공간과 해시 링
- 실제 안정 해시의 동작원리이다. 해시 함수 f로 SHA-1을 사용한다고 하고, 출력 값 범위는 x0 ... xn이라고 하자. 
- SHA-1의 해시공간 범위는 0부터 2^160 - 1까지라 알려져 있다. 

![image](https://github.com/11th-SSAFY-19/large-scale-system-design/assets/80228712/7d17834d-a485-4bfa-a7ae-863589876844)

- 이 해시 공간을 양쪽으로 구부려 접으면 아래와 같은 해시 링이 만들어진다.

![image](https://github.com/11th-SSAFY-19/large-scale-system-design/assets/80228712/17c096a0-c2dd-4380-a476-fb2b3129fb31)

### 해시 서버와 해시 키
- 해시 함수 f를 사용하면 서버 IP나 이름을 링 위의 어떤 위치에 대응시킬 수 있다.
- 예제를 위해 `해시 키 재배치 문제`에서 언급되지 않은 함수를 사용하여 키를 배치 할 수 있다.

![image](https://github.com/11th-SSAFY-19/large-scale-system-design/assets/80228712/a5a78a1f-ca8c-4135-a35d-3d35a9038bb0)

### ✨서버 조회
- 어떤 키가 저장되는 서버는 해당 키의 위치로부터 시계 방향으로 링을 탐색해 만나는 첫번째 서버에 저장된다.

![image](https://github.com/11th-SSAFY-19/large-scale-system-design/assets/80228712/b94440e3-7b37-4672-9a6a-bac295437fc7)
- 이에 따르면, k0은 서버0에 key1은 서버1에 key2는 서버2에 key3는 서버3에 저장된다.

### ✨서버 추가
- 안정해시는 서버를 추가하더라도 키 가운데 일부분만 재배치하면 된다. server4를 추가한다고 하였을 때의 예시를 보자면

![image](https://github.com/11th-SSAFY-19/large-scale-system-design/assets/80228712/244ca185-43fa-428d-9585-8df9c03a78c1)

- key0만 server 4에 재배치 되고 나머지는 그대로 원래 캐시서버에 찾아가는 것을 알 수 있다.

### ✨서버 제거
- 하나의 서버가 제거되면 키 가운데 일부만 재배치된다. 서버1이 삭제되었을 때 key1만이 서버 2로 재배치됨을 알 수 있다. 나머지 키에는 영향이 없다.
![image](https://github.com/11th-SSAFY-19/large-scale-system-design/assets/80228712/d342f1b6-88bc-4edf-8ed0-226cf10d05f0)

### ✨안정 해시의 문제점
안정 해시 알고리즘의 기본 절차는 <br>
1. 서버와 키를 균등 분포 해시 함수를 사용해 해시 링에 배치한다.
2. 키의 위치에서 링을 시계 방향으로 탐색하다 만나는 최초의 서버가 키가 저장될 서거이다.

**🧨 문제점!**
1. 서버가 추가되거나 삭제되는 상황을 감안하면 **파티션의 크기를 균등하게 유지하는게 불가능**하다.<br><br>
즉, 어떤 서버는 굉장히 작은 해시 공간을 할당 받고, 어떤 서버는 굉장히 큰 해시 공간을 할당 받는 상황이 가능해진다.
![image](https://github.com/11th-SSAFY-19/large-scale-system-design/assets/80228712/3614faf7-ff06-49fa-9810-07eddd9be8d7)

    위와 같이, s1이 지워짐을 통해 s2가 받는 부하가 두배로 늘어나게 된다.

2. **키의 균등 분포**를 달성하기가 어렵다.
![image](https://github.com/11th-SSAFY-19/large-scale-system-design/assets/80228712/1d044bcd-97fd-4945-bb89-a80a2521fabf)
    위와 같은 상황에서 서버1과 서버 3은 하나의 데이터도 못가지는 반면 대부분의 키는 서버2에 저장될 것이다.

**💡 위 문제들을 해결하기 위해 `가상 노드` 또는 `replica`라는 기법이 나오게 되었다.**

### ✨가상 노드
- 가상 노드는 실제 노드 또는 서버를 가리키는 노드로서, 하나의 서버는 링 위에 여러 개의 가상 노드를 갖는다.
![image](https://github.com/11th-SSAFY-19/large-scale-system-design/assets/80228712/23da86e9-7752-4ead-84f0-aaf6d1a983e9)
- 위와 같이 서버 1과 서버 0은 각각 여러개의 가상노드(s1_0, s1_1, s1_2)를 가지고 각 노드별 관리하는 파티션을 여러개로 나누어 키의 균등분포 및 파티션의 크기를 비슷하게 나눌 수 있다.
- 가상 노드의 개수를 늘리면 키의 분포는 점점 더 균등해진다. 하지만, 가상 노드를 저장할 공간이 더 많이 필요하기 때문에 시스템의 요구사항에 맞도록 가상 노드 개수를 적절히 조정해야 한다.

## 총정리
**안정해시의 이점!!!**
1. 서버가 추가되거나 삭제될 때 재배치되는 키의 수가 최소화된다.
2. 데이터가 균등하게 분포되므로 수평적 규모 확장성을 달성하기 쉽다.
3. 핫스팟키 문제를 줄인다. 데이터를 좀 더 균등하게 분배하므로 문제가 생길 가능성이 줄어든다.

# 사진 출처
https://luna-archive.tistory.com/48